/****l* Mercado Pago/OFB:post:SVAL99600_mpago
* NOMBRE
*   OFB:post:SVAL99600_mpago
* DESCRIPCION
*   Rutina de Confirmacion de la TX de Anulacion de Venta con Tarjeta.
* ENTRADAS
*   Parámetros de entrada de la rutina, sean argumentos o campos que tiene en cuenta
* SALIDAS
*   Campos modificados como resultado o returns cuyos valores sean no triviales
* IMPACTOS
*   Otros objetos que deberán ser analizados al modificar el objeto actual
* REFERENCIADO POR
*   LST:post:TRAN99600
* DOCUMENTACION
*   NI50546 - Mercado Pago 
* SOURCE
*/
#include "postsval.h"

SUB post:SVAL99600_mpago
	LOCAL l_mensaje LIKE common:csr_string
	LOCAL l_status_refund LIKE common:csr_string
	LOCAL l_status_esperado LIKE common:csr_string
	LOCAL l_refund_id LIKE common:csr_string
	LOCAL l_es_point LIKE siaf:i

	IF (post:mp_codint_mp == "QRI") THEN
		l_es_point = 0
	ELSE
		l_es_point = 1
	END IF
	
	//Determino status a mostrar/validar segun canal
	IF (l_es_point) THEN
		l_status_refund = post:mp_refund_status_PS
		IF (l_status_refund == "")
			l_status_refund = post:mp_refund_status
		END IF
		l_refund_id = post:mp_refund_id_PS
		l_status_esperado = "processed"
	ELSE
		l_status_refund = post:mp_refund_status
		l_refund_id = post:mp_refund_id
		l_status_esperado = "approved"
	END IF

	//Consulto el estado del pago
	CALL post:MISCmpGetRefund
	IF (RETVAL == 0) THEN
		IF (l_es_point) THEN
			l_status_refund = post:mp_refund_status_PS
			IF (l_status_refund == "")
				l_status_refund = post:mp_refund_status
			END IF
			l_refund_id = post:mp_refund_id_PS
			l_status_esperado = "processed"
		ELSE
			l_status_refund = post:mp_refund_status
			l_refund_id = post:mp_refund_id
			l_status_esperado = "approved"
		END IF
		IF (l_refund_id == "" && l_status_refund == "") THEN
			//Hago la devolucion
			CALL post:MISCmpRefundPayment
			IF (l_es_point) THEN
				l_status_refund = post:mp_refund_status_PS
				IF (l_status_refund == "")
					l_status_refund = post:mp_refund_status
				END IF
			ELSE
				l_status_refund = post:mp_refund_status
			END IF
			IF (RETVAL < 0) THEN
				FPRINT l_mensaje ,"NO SE PUEDE ANULAR EL PAGO\n STATUS [%s]", l_status_refund
				MSGBOX l_mensaje,OFB_OK,"ERROR"
				RETURN -2
			END IF
			IF (l_status_refund != l_status_esperado) THEN
					FPRINT l_mensaje ,"NO SE PUEDE ANULAR EL PAGO\n STATUS [%s]", l_status_refund
					MSGBOX l_mensaje,OFB_OK,"ERROR"
					RETURN -2
			ELSE
				//Consulto el estado del pago
				CALL post:MISCmpGetRefund
				IF (RETVAL < 0)
					FPRINT l_mensaje ,"NO SE PUDO OBTENER LOS DATOS DEL PAGO\n STATUS [%s]", l_status_refund
					MSGBOX l_mensaje,OFB_OK,"ERROR"
				END IF
			END IF
		ELSE
			IF (l_status_refund != l_status_esperado) THEN
				FPRINT l_mensaje ,"NO SE PUEDE ANULAR EL PAGO\n STATUS [%s]", l_status_refund
				MSGBOX l_mensaje,OFB_OK,"ERROR"
				RETURN -2
			END IF
		END IF
	ELSE
		FPRINT l_mensaje ,"NO SE PUEDE ANULAR EL PAGO\n STATUS [%s]", l_status_refund
		MSGBOX l_mensaje,OFB_OK,"ERROR"
		RETURN -2
	END IF
	
	IF (l_es_point) THEN
		LET post:NroCompPago2AN = post:mp_refund_id_PS
		LET post:Nro_Lote_PosAN = post:mp_order_id_PS
	ELSE
		LET post:NroCompPago2AN = post:mp_refund_id
		LET post:Nro_Lote_PosAN = post:mp_order_id
	END IF
	LET post:NroTransacAN = post:mp_auth_code
	
	REFRESH post:NroCompPago2AN
	REFRESH post:Nro_Lote_PosAN
	REFRESH post:NroTransacAN
	
	//Imprimo Ticko
	IF (!TESTFLAG(tlr:tran_flags,correction)) THEN
		SETFLAG tlr:tran_flags,correction
	END IF
	CALL post:MISCticko_MP
	
	RESETFLAG tlr:tran_flags,correction
	
END SUB

/*******/
