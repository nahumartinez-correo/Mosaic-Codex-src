/****o* Mercado Pago/OFB:post:MISCmpRefundPayment
* NOMBRE
*   OFB:post:MISCmpRefundPayment
* DESCRIPCION
*   Realiza la Devolucion de un Pago de Mercado Pago - POINT / QR Integrado
* ENTRADAS
*   Parámetros de entrada de la rutina, sean argumentos o campos que tiene en cuenta
* SALIDAS
*   Campos modificados como resultado o returns cuyos valores sean no triviales
* IMPACTOS
*   Otros objetos que deberán ser analizados al modificar el objeto actual
* REFERENCIADO POR
*   
* DOCUMENTACION
*   NI50546 - Mercado Pago
* SOURCE
*/
#include "src\POST\misc\postmisc.h"
SUB post:MISCmpRefundPayment
	LOCAL l_retval LIKE lib:err_retval
	
	IF (post:mp_codint_mp == "QRI") THEN
		LET post:mp_comandos = "QR_REFUND_POST"
	ELSE
		LET post:mp_comandos = "POINT_REFUND_POST"

		//Smart Point: completo datos locales de la venta original antes de enviar el refund 200025
		IF (post:mp_order_id_PS.NUMCHARS == 0 && post:adt_opmp_order_id_PS.NUMCHARS > 0) THEN
			LET post:mp_order_id_PS = post:adt_opmp_order_id_PS
		END IF
		IF (post:mp_order_id.NUMCHARS == 0 && post:adt_opmp_order_id > 0) THEN
			LET post:mp_order_id = post:adt_opmp_order_id
		END IF
		IF (post:mp_payment_id_PS.NUMCHARS == 0 && post:adt_opmp_pay_id_PS.NUMCHARS > 0) THEN
			LET post:mp_payment_id_PS = post:adt_opmp_pay_id_PS
		END IF
		IF (post:mp_payment_id == 0 && post:adt_opmp_payment_id != 0) THEN
			LET post:mp_payment_id = post:adt_opmp_payment_id
		END IF
		IF (post:mp_auth_code.NUMCHARS == 0 && post:adt_opmp_auth_code.NUMCHARS > 0) THEN
			LET post:mp_auth_code = post:adt_opmp_auth_code
		END IF
		IF (post:mp_amount.NUMCHARS == 0 && post:adt_opmp_amount.NUMCHARS > 0) THEN
			LET post:mp_amount = post:adt_opmp_amount
		END IF
	END IF
	
	LET post:mp_operacion = "DEV"

	DPRINT "<<<*************[%s]*********************\n" post:mp_comandos
	DPRINT "[post:mp_payment_id][%s]\n" post:mp_payment_id
	DPRINT "****************[%s]******************>>>\n" post:mp_comandos

	//Rutina generica para el consumo de los WS de Mercado Pago
	CALL post:OFBws_mercadopago

	DPRINT "post:mp_tmp_adic[0][%s]\n" post:mp_tmp_adic[0]
	DPRINT "post:mp_tmp_adic[1][%s]\n" post:mp_tmp_adic[1]
	DPRINT "post:mp_tmp_adic[2][%s]\n" post:mp_tmp_adic[2]
	DPRINT "post:mp_tmp_adic[3][%s]\n" post:mp_tmp_adic[3]
	DPRINT "post:mp_tmp_adic[4][%s]\n" post:mp_tmp_adic[4]
	
	// DEVONLY:PAUSE_REFUND_200025 BEGIN
	// DEVONLY:PAUSE_REFUND_200025 A1
	IF (post:mp_comandos == "POINT_REFUND_POST" && giros:codigo_procesamiento == 200025) THEN
		MSGBOX "DEV PAUSE A1: Refund 200025 Host RX (pre-parse)",OFB_OK,"DEV"
	END IF
	// DEVONLY:PAUSE_REFUND_200025 END
	
	//Rutina generica para el tratamiento de la respuesta de los WS de Mercado Pago
	CALL post:OFBresponse_ws_mp
	
	DPRINT "post:mp_response[%s]\n" post:mp_response
	IF (post:mp_response == 200 || post:mp_response == 201) THEN
		DPRINT "post:mp_refund_status[%s]\n" post:mp_refund_status
		DPRINT "post:mp_refund_id[%s]\n" post:mp_refund_id
		DPRINT "post:mp_refund_amount[%s]\n" post:mp_refund_amount
		DPRINT "post:mp_refund_date[%s]\n" post:mp_refund_date
		DPRINT "post:mp_refund_payment_id[%s]\n" post:mp_refund_payment_id
		
		IF (post:mp_codint_mp != "QRI") THEN
			//Compatibilidad de datos cuando la respuesta 200025 no informa todos los campos
			IF (post:mp_refund_id.NUMCHARS == 0) THEN
				LET post:mp_refund_id = post:mp_refund_id_PS
			END IF
			IF (post:mp_refund_status.NUMCHARS == 0) THEN
				LET post:mp_refund_status = post:mp_refund_status_PS
			END IF
			IF (post:mp_refund_payment_id.NUMCHARS == 0) THEN
				LET post:mp_refund_payment_id = post:mp_refund_pay_id_PS
			END IF
			IF (post:mp_refund_amount.NUMCHARS == 0 && post:adt_opmp_amount.NUMCHARS > 0) THEN
				LET post:mp_refund_amount = post:adt_opmp_amount
			END IF
			IF (post:mp_refund_date.NUMCHARS == 0) THEN
				LET post:mp_refund_date = common:system_date
			END IF
		END IF

		LET l_retval = 0
		
		//Grabo en la tabla OperacionesMP
		CALL post:MISCsaveOpeMP(post:mp_operacion,post:mp_comandos)
		
	ELSE
		DPRINT "post:mp_response_code[%s]\n" post:mp_response_code
		DPRINT "post:mp_status][%s]\n" post:mp_status
		DPRINT "post:mp_response_error][%s]\n" post:mp_response_error
		DPRINT "post:mp_response_message][%s]\n" post:mp_response_message
		DPRINT "post:mp_response_cause][%s]\n" post:mp_response_cause
		
		LET l_retval = -2

	END IF
	
	RETURN l_retval
	
END SUB
/*******/
